<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一元二次方程式探測器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .sup-text { font-size: 0.6em; vertical-align: super; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icons = {
            Refresh: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="text-green-400"><polyline points="20 6 9 17 4 12"/></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="text-red-400"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Brain: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Search: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            List: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            CheckSquare: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Zap: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Scissors: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>
        };

        // --- 任務 1: 判斷方程式 ---
        const IdentificationStage = () => {
            const [problem, setProblem] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [streak, setStreak] = useState(0);

            const generate = () => {
                const types = [
                    { type: 'valid_std', text: 'x² - 3x + 2 = 0', isValid: true, reason: '符合標準式 ax² + bx + c = 0' },
                    { type: 'valid_fact', text: '(x + 1)(x - 2) = 0', isValid: true, reason: '展開後最高次方為 2，且有等號' },
                    { type: 'valid_simple', text: '3x² = 12', isValid: true, reason: '整理後為 3x² - 12 = 0，是一元二次方程式' },
                    { type: 'valid_messy', text: 'x² + 5x = 6', isValid: true, reason: '有等號，且最高次方為 2' },
                    { type: 'invalid_poly', text: 'x² + 2x + 1', isValid: false, reason: '這只是多項式，缺少「等號」，不是方程式' },
                    { type: 'invalid_linear', text: '5x + 3 = 0', isValid: false, reason: '最高次方只有 1，這是一元「一次」方程式' },
                    { type: 'invalid_linear_hidden', text: 'x² + 3x = x² + 5', isValid: false, reason: '左右兩邊的 x² 消掉了，其實是 3x = 5 (一次方程式)' },
                    { type: 'invalid_var', text: 'x + y = 3', isValid: false, reason: '有兩個未知數 (x, y)，這是「二元」方程式' },
                ];
                const p = types[Math.floor(Math.random() * types.length)];
                let display = p.text;
                if (p.type === 'valid_std') {
                    const a = Math.floor(Math.random()*5)+1;
                    display = `${a > 1 ? a : ''}x² ${Math.random()>0.5?'+':'-'} ${Math.floor(Math.random()*9)+1}x ${Math.random()>0.5?'+':'-'} ${Math.floor(Math.random()*9)+1} = 0`;
                }
                setProblem({ ...p, display });
                setFeedback(null);
            };

            useEffect(() => generate(), []);

            const check = (userSaysYes) => {
                const isCorrect = userSaysYes === problem.isValid;
                setFeedback({
                    correct: isCorrect,
                    text: isCorrect ? '答對了！' : '答錯囉！',
                    detail: problem.reason
                });
                if (isCorrect) setStreak(s => s + 1);
                else setStreak(0);
            };

            return (
                <div className="flex flex-col items-center w-full max-w-2xl animate-fade-in">
                    <div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full text-center relative overflow-hidden">
                         <div className="absolute top-0 right-0 p-4 opacity-50"><span className="text-xs uppercase tracking-wider">Streak</span> <span className="text-xl font-bold text-indigo-400">{streak}</span></div>
                        <h2 className="text-slate-400 mb-6 text-sm font-bold uppercase tracking-wider">任務 1：這是「一元二次方程式」嗎？</h2>
                        <div className="text-4xl md:text-5xl font-mono font-bold mb-8 py-4 bg-slate-900 rounded-lg">{problem?.display}</div>
                        {!feedback ? (
                            <div className="flex gap-4 justify-center">
                                <button onClick={() => check(true)} className="flex-1 bg-indigo-600 hover:bg-indigo-500 py-4 px-8 rounded-xl font-bold text-xl transition-transform hover:scale-105 flex items-center justify-center gap-2"><Icons.Check /> 是 (O)</button>
                                <button onClick={() => check(false)} className="flex-1 bg-slate-700 hover:bg-slate-600 py-4 px-8 rounded-xl font-bold text-xl transition-transform hover:scale-105 flex items-center justify-center gap-2"><Icons.X /> 否 (X)</button>
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                <div className={`p-4 rounded-lg mb-4 ${feedback.correct ? 'bg-green-900/30 text-green-300 border border-green-500/50' : 'bg-red-900/30 text-red-300 border border-red-500/50'}`}>
                                    <div className="font-bold text-xl mb-1">{feedback.text}</div>
                                    <div>{feedback.detail}</div>
                                </div>
                                <button onClick={generate} className="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-full font-bold">下一題</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 任務 2: 檢驗解 ---
        const VerificationStage = () => {
            const [problem, setProblem] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [streak, setStreak] = useState(0);

            const generate = () => {
                const r1 = Math.floor(Math.random() * 7) - 3;
                let r2 = Math.floor(Math.random() * 7) - 3;
                const a = 1; 
                const b = -(r1 + r2);
                const c = r1 * r2;
                const isRealSolution = Math.random() > 0.5;
                let testVal = isRealSolution ? (Math.random() > 0.5 ? r1 : r2) : (r1 + (Math.floor(Math.random()*3)+1)); 
                let eqStr = "x²";
                if (b > 0) eqStr += ` + ${b}x`; else if (b < 0) eqStr += ` - ${Math.abs(b)}x`;
                if (c > 0) eqStr += ` + ${c}`; else if (c < 0) eqStr += ` - ${Math.abs(c)}`;
                eqStr += " = 0";
                setProblem({ a, b, c, testVal, isRealSolution, display: eqStr });
                setFeedback(null);
            };

            useEffect(() => generate(), []);

            const check = (userSaysYes) => {
                const isCorrect = userSaysYes === problem.isRealSolution;
                const { a, b, c, testVal } = problem;
                const val = a * testVal * testVal + b * testVal + c;
                setFeedback({ correct: isCorrect, val: val, isZero: val === 0 });
                if (isCorrect) setStreak(s => s + 1); else setStreak(0);
            };

            return (
                <div className="flex flex-col items-center w-full max-w-2xl animate-fade-in">
                    <div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full text-center relative">
                        <div className="absolute top-0 right-0 p-4 opacity-50"><span className="text-xs uppercase tracking-wider">Streak</span> <span className="text-xl font-bold text-indigo-400">{streak}</span></div>
                        <h2 className="text-slate-400 mb-6 text-sm font-bold uppercase tracking-wider">任務 2：檢驗解 (代入看看)</h2>
                        <div className="mb-4 text-xl">請問 <span className="text-yellow-400 font-bold bg-slate-900 px-2 py-1 rounded">x = {problem?.testVal}</span> 是下列方程式的解嗎？</div>
                        <div className="text-4xl md:text-5xl font-mono font-bold mb-8 py-4 bg-slate-900 rounded-lg text-slate-200">{problem?.display}</div>
                        {!feedback ? (
                            <div className="flex gap-4 justify-center">
                                <button onClick={() => check(true)} className="flex-1 bg-indigo-600 hover:bg-indigo-500 py-4 px-8 rounded-xl font-bold text-xl transition-transform hover:scale-105 flex items-center justify-center gap-2"><Icons.Check /> 是 (O)</button>
                                <button onClick={() => check(false)} className="flex-1 bg-slate-700 hover:bg-slate-600 py-4 px-8 rounded-xl font-bold text-xl transition-transform hover:scale-105 flex items-center justify-center gap-2"><Icons.X /> 否 (X)</button>
                            </div>
                        ) : (
                            <div className="animate-fade-in text-left bg-slate-900 p-6 rounded-xl border border-slate-700">
                                <h3 className="text-slate-400 text-sm font-bold mb-2 flex items-center"><Icons.Brain /> <span className="ml-2">代入檢查：</span></h3>
                                <div className="font-mono text-xl mb-4">
                                    ({problem.testVal})² {problem.b >= 0 ? '+' : '-'} {Math.abs(problem.b)}({problem.testVal}) {problem.c >= 0 ? '+' : '-'} {Math.abs(problem.c)}
                                    <br/>
                                    = <span className={feedback.isZero ? "text-green-400 font-bold" : "text-red-400 font-bold"}>{feedback.val}</span>
                                    {feedback.isZero ? " (剛好歸零！)" : " (不是 0)"}
                                </div>
                                <div className={`text-lg font-bold mb-4 ${feedback.correct ? 'text-green-400' : 'text-red-400'}`}>{feedback.correct ? '判斷正確！' : '判斷錯誤，請看上方計算'}</div>
                                <button onClick={generate} className="w-full bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-xl font-bold">下一題</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 任務 3: 尋找解 ---
        const SolvingStage = () => {
            const [level, setLevel] = useState(1);
            const [problem, setProblem] = useState(null);
            const [selectedChoice, setSelectedChoice] = useState(null);
            const [result, setResult] = useState(null);
            const [score, setScore] = useState(0);

            const generateProblem = () => {
                let r1 = Math.floor(Math.random() * 11) - 5; 
                let r2 = 0, type = '';
                if (level === 1) {
                    if (r1 === 0) r1 = 2; r2 = -r1; type = 'simple_square';
                } else {
                    r2 = Math.floor(Math.random() * 11) - 5;
                    while (r2 === r1) r2 = Math.floor(Math.random() * 11) - 5;
                    type = 'standard';
                }
                const choicesSet = new Set([r1, r2]);
                while(choicesSet.size < 4) choicesSet.add(Math.floor(Math.random() * 15) - 7);
                setProblem({ r1, r2, type, choices: Array.from(choicesSet).sort(() => Math.random() - 0.5) });
                setSelectedChoice(null);
                setResult(null);
            };

            useEffect(() => generateProblem(), [level]);

            const handleSelect = (val) => {
                if (selectedChoice !== null) return;
                setSelectedChoice(val);
                const isCorrect = (val === problem.r1 || val === problem.r2);
                setResult(isCorrect ? 'correct' : 'wrong');
                if (isCorrect) setScore(s => s + 10);
            };

            const next = () => {
                if (score >= 30 && level === 1) setLevel(2);
                generateProblem();
            };

            const renderEquation = () => {
                if (!problem) return null;
                const { r1, r2, type } = problem;
                if (type === 'simple_square') {
                    return <div className="text-5xl font-mono font-bold tracking-wider my-8 text-center">x<span className="sup-text text-3xl">2</span> = {r1*r1}</div>;
                } else {
                    const b = -(r1 + r2); const c = r1 * r2;
                    let bStr = b===1?'+ x':(b===-1?'- x':(b>0?`+ ${b}x`:(b<0?`- ${Math.abs(b)}x`:'')));
                    let cStr = c>0?`+ ${c}`:(c<0?`- ${Math.abs(c)}`:'');
                    return <div className="text-4xl md:text-5xl font-mono font-bold tracking-wider my-8 text-center">x<span className="sup-text text-3xl">2</span> {bStr} {cStr} = 0</div>;
                }
            };

            return (
                <div className="w-full flex flex-col items-center animate-fade-in">
                     <div className="w-full flex justify-between items-center mb-4 px-4">
                        <div className="flex gap-2"><span className={`px-2 py-0.5 rounded text-xs border ${level===1 ? 'bg-indigo-900 border-indigo-500 text-indigo-200' : 'border-slate-700 text-slate-500'}`}>Level 1 (簡單)</span><span className={`px-2 py-0.5 rounded text-xs border ${level===2 ? 'bg-indigo-900 border-indigo-500 text-indigo-200' : 'border-slate-700 text-slate-500'}`}>Level 2 (標準)</span></div>
                        <div className="text-xl font-mono text-indigo-400">Score: {score}</div>
                     </div>
                    <div className="bg-slate-800 rounded-2xl p-8 w-full shadow-2xl border border-slate-700 relative overflow-hidden">
                        <p className="text-center text-slate-400 mb-2">任務 3：找出能讓等式成立的 x</p>
                        {renderEquation()}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
                            {problem && problem.choices.map((val, idx) => {
                                let btnStyle = "bg-slate-700 hover:bg-slate-600 border-slate-600";
                                let icon = null;
                                if (selectedChoice !== null) {
                                    if (val === selectedChoice) {
                                        if (result === 'correct') { btnStyle = "bg-green-900/50 border-green-500 text-green-300 ring-2 ring-green-500/50"; icon = <Icons.Check />; }
                                        else { btnStyle = "bg-red-900/50 border-red-500 text-red-300"; icon = <Icons.X />; }
                                    } else btnStyle = "opacity-30 pointer-events-none";
                                }
                                return <button key={idx} onClick={() => handleSelect(val)} disabled={selectedChoice !== null} className={`relative h-20 text-2xl font-mono font-bold rounded-xl border-2 transition-all duration-200 flex items-center justify-center ${btnStyle}`}>{val} {icon && <div className="absolute top-1 right-1">{icon}</div>}</button>;
                            })}
                        </div>
                    </div>
                    {selectedChoice !== null && (
                        <div className="mt-8">{result === 'correct' ? <button onClick={next} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-indigo-500/30 transition-all hover:scale-105">下一題 <Icons.Refresh /></button> : <button onClick={() => { setSelectedChoice(null); setResult(null); }} className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-full font-bold transition-all">再試一次</button>}</div>
                    )}
                </div>
            );
        };

        // --- 任務 4: 零乘積性質概念挑戰 (New Enhanced) ---
        const ZeroProductConceptStage = () => {
            const [streak, setStreak] = useState(0);
            const [problem, setProblem] = useState(null);
            const [feedback, setFeedback] = useState(null);

            const generate = () => {
                const types = ['fill_blank', 'concept_select'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                if (type === 'fill_blank') {
                    // Type 1: 5 * ? = 0
                    const known = Math.floor(Math.random() * 9) + 1; // 1-9
                    const isLeft = Math.random() > 0.5;
                    setProblem({
                        type: 'fill_blank',
                        known,
                        isLeft,
                        answer: 0,
                        options: [0, known, -known, 1].sort(()=>Math.random()-0.5)
                    });
                } else {
                    // Type 2: 哪一組乘積為零？
                    const pairs = [
                        { a: 3, b: 0, isZero: true },
                        { a: 2, b: 2, isZero: false },
                        { a: 0, b: -5, isZero: true },
                        { a: 1, b: 1, isZero: false },
                        { a: -3, b: 0, isZero: true }
                    ];
                    // 選一個正確的(有0的)，三個錯誤的(沒0的)
                    const correctPair = pairs.filter(p=>p.isZero)[Math.floor(Math.random()*3)];
                    const wrongPairs = [
                        { a: Math.floor(Math.random()*5)+1, b: Math.floor(Math.random()*5)+1 },
                        { a: -(Math.floor(Math.random()*5)+1), b: Math.floor(Math.random()*5)+1 },
                        { a: 1, b: 1 }
                    ];
                    setProblem({
                        type: 'concept_select',
                        correctPair,
                        options: [correctPair, ...wrongPairs].sort(()=>Math.random()-0.5)
                    });
                }
                setFeedback(null);
            };

            useEffect(() => generate(), []);

            const check = (choice) => {
                let isCorrect = false;
                if (problem.type === 'fill_blank') {
                    isCorrect = choice === 0;
                } else {
                    // concept_select: choice is object {a, b}
                    isCorrect = (choice.a === 0 || choice.b === 0);
                }

                if (isCorrect) {
                    setFeedback({ correct: true, text: "正確！乘積為 0，其中一個一定要是 0。" });
                    setStreak(s => s + 1);
                } else {
                    setFeedback({ correct: false, text: "錯囉！兩個都不是 0 的數字乘起來不會是 0。" });
                    setStreak(0);
                }
            };

            return (
                <div className="flex flex-col items-center w-full max-w-2xl animate-fade-in">
                    <div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full text-center relative">
                        <div className="absolute top-0 right-0 p-4 opacity-50"><span className="text-xs uppercase tracking-wider">Streak</span> <span className="text-xl font-bold text-indigo-400">{streak}</span></div>
                        <h2 className="text-slate-400 mb-6 text-sm font-bold uppercase tracking-wider">任務 4：零乘積性質 (觀念養成)</h2>
                        
                        {problem?.type === 'fill_blank' && (
                            <div className="animate-fade-in">
                                <p className="mb-6 text-xl">請填入正確的數字讓等式成立：</p>
                                <div className="text-4xl md:text-5xl font-mono font-bold mb-8 py-6 bg-slate-900 rounded-lg flex justify-center items-center gap-4">
                                    {problem.isLeft ? (
                                        <><span className="text-indigo-400">{problem.known}</span> <span>×</span> <span className="bg-slate-700 px-4 py-2 rounded text-yellow-400 border-2 border-dashed border-yellow-600">?</span></>
                                    ) : (
                                        <><span className="bg-slate-700 px-4 py-2 rounded text-yellow-400 border-2 border-dashed border-yellow-600">?</span> <span>×</span> <span className="text-indigo-400">{problem.known}</span></>
                                    )}
                                    <span>=</span>
                                    <span>0</span>
                                </div>
                                {!feedback ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {problem.options.map((opt, i) => (
                                            <button key={i} onClick={() => check(opt)} className="bg-slate-700 hover:bg-slate-600 py-4 rounded-xl font-bold text-2xl transition-all">{opt}</button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                                        <p className={`text-lg font-bold ${feedback.correct ? 'text-green-400' : 'text-red-400'}`}>{feedback.text}</p>
                                        <button onClick={generate} className={`mt-4 px-6 py-2 rounded-full font-bold text-white ${feedback.correct ? 'bg-indigo-600 hover:bg-indigo-500' : 'bg-slate-600 hover:bg-slate-500'}`}>{feedback.correct ? '下一題' : '再試一次'}</button>
                                    </div>
                                )}
                            </div>
                        )}

                        {problem?.type === 'concept_select' && (
                            <div className="animate-fade-in">
                                <p className="mb-6 text-xl">哪一組數字相乘會等於 0？</p>
                                {!feedback ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {problem.options.map((pair, i) => (
                                            <button key={i} onClick={() => check(pair)} className="bg-slate-700 hover:bg-slate-600 py-6 px-4 rounded-xl font-bold text-2xl transition-all font-mono">
                                                {pair.a} × {pair.b}
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                                        <p className={`text-lg font-bold ${feedback.correct ? 'text-green-400' : 'text-red-400'}`}>{feedback.text}</p>
                                        <button onClick={generate} className={`mt-4 px-6 py-2 rounded-full font-bold text-white ${feedback.correct ? 'bg-indigo-600 hover:bg-indigo-500' : 'bg-slate-600 hover:bg-slate-500'}`}>{feedback.correct ? '下一題' : '再試一次'}</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 任務 5: 因式分解解方程式 (獨立任務) ---
        const FactorizationStage = () => {
            const [problem, setProblem] = useState(null);
            const [feedback, setFeedback] = useState(null);
            
            const generate = () => {
                const a = Math.floor(Math.random() * 10) - 5;
                const b = Math.floor(Math.random() * 10) - 5;
                setProblem({ a, b });
                setFeedback(null);
            };

            useEffect(() => generate(), []);

            const handleAlgebraAction = (target) => {
                const xVal = target === 'left' ? problem.a : problem.b;
                const leftPart = xVal - problem.a;
                const rightPart = xVal - problem.b;
                setFeedback({
                    correct: true,
                    xVal: xVal,
                    calc: `(${xVal} ${problem.a>=0?'-':'+'} ${Math.abs(problem.a)}) × (${xVal} ${problem.b>=0?'-':'+'} ${Math.abs(problem.b)}) = ${leftPart} × ${rightPart} = 0`
                });
            };

            return (
                <div className="flex flex-col items-center w-full max-w-2xl animate-fade-in">
                    <div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full text-center relative">
                        <h2 className="text-slate-400 mb-6 text-sm font-bold uppercase tracking-wider">任務 5：因式分解解方程式 (括號挑戰)</h2>
                        
                        {problem && (
                            <div className="animate-fade-in">
                                <p className="mb-4 text-lg">只要讓<span className="text-yellow-400 font-bold mx-1">其中一個括號</span>變成 0，整個式子就是 0！</p>
                                <div className="text-3xl md:text-5xl font-mono font-bold mb-8 py-6 bg-slate-900 rounded-lg text-slate-300">
                                    (x {problem.a >= 0 ? '-' : '+'} {Math.abs(problem.a)}) (x {problem.b >= 0 ? '-' : '+'} {Math.abs(problem.b)}) = 0
                                </div>

                                {!feedback ? (
                                    <div className="flex flex-col gap-4">
                                        <p className="text-slate-400 text-sm">請選擇一種策略來消滅這個方程式：</p>
                                        <div className="flex flex-col md:flex-row gap-4 justify-center">
                                            <button onClick={() => handleAlgebraAction('left')} className="bg-indigo-600 hover:bg-indigo-500 py-4 px-6 rounded-xl font-bold text-lg flex-1 border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1 transition-all">
                                                讓左邊括號 = 0 <br/>
                                                <span className="text-sm font-normal opacity-80">(選 x = {problem.a})</span>
                                            </button>
                                            <button onClick={() => handleAlgebraAction('right')} className="bg-cyan-600 hover:bg-cyan-500 py-4 px-6 rounded-xl font-bold text-lg flex-1 border-b-4 border-cyan-800 active:border-b-0 active:translate-y-1 transition-all">
                                                讓右邊括號 = 0 <br/>
                                                <span className="text-sm font-normal opacity-80">(選 x = {problem.b})</span>
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-slate-900 p-6 rounded-xl border border-slate-700 text-left">
                                        <div className="flex items-center gap-2 mb-2 text-green-400 font-bold text-lg"><Icons.Check /> 成功歸零！</div>
                                        <div className="font-mono text-xl mb-4 text-slate-300">
                                            代入 x = <span className="text-yellow-400">{feedback.xVal}</span>：<br/>
                                            {feedback.calc}
                                        </div>
                                        <p className="text-slate-400 text-sm mb-4">第一性原理：因為 {feedback.xVal === problem.a ? '左邊' : '右邊'}變成了 0，所以乘積必定為 0。</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => setFeedback(null)} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl">試試另一個解</button>
                                            <button onClick={generate} className="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl">下一題</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const QuadraticExplorer = () => {
            const { useState } = React;
            const [mode, setMode] = useState('identify');

            const navBtnClass = (active) => 
                `flex items-center px-4 py-3 rounded-lg transition-all text-sm md:text-base whitespace-nowrap ${active ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800'}`;

            return (
                <div className="min-h-screen flex flex-col items-center p-4 max-w-5xl mx-auto pb-20">
                    <header className="w-full mb-8">
                        <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent text-center mb-6">二次方程式探測器</h1>
                        <nav className="flex flex-wrap justify-center gap-2 p-2 bg-slate-900 rounded-xl max-w-4xl mx-auto border border-slate-700 overflow-x-auto">
                            <button onClick={() => setMode('identify')} className={navBtnClass(mode==='identify')}><Icons.Search /> <span className="ml-2">1. 判斷方程式</span></button>
                            <button onClick={() => setMode('verify')} className={navBtnClass(mode==='verify')}><Icons.CheckSquare /> <span className="ml-2">2. 檢驗解</span></button>
                            <button onClick={() => setMode('solve')} className={navBtnClass(mode==='solve')}><Icons.List /> <span className="ml-2">3. 尋找解</span></button>
                            <button onClick={() => setMode('zeroprod')} className={navBtnClass(mode==='zeroprod')}><Icons.Zap /> <span className="ml-2">4. 零乘積性質</span></button>
                            <button onClick={() => setMode('factor')} className={navBtnClass(mode==='factor')}><Icons.Scissors /> <span className="ml-2">5. 因式分解解題</span></button>
                        </nav>
                    </header>

                    <main className="w-full flex-1 flex flex-col items-center">
                        {mode === 'identify' && <IdentificationStage />}
                        {mode === 'verify' && <VerificationStage />}
                        {mode === 'solve' && <SolvingStage />}
                        {mode === 'zeroprod' && <ZeroProductConceptStage />}
                        {mode === 'factor' && <FactorizationStage />}
                    </main>

                    <footer className="mt-12 text-center text-slate-500 text-xs">
                        <p>第一性原理學習路徑：定義 → 驗證 → 直覺 → 核心性質(零乘積) → 系統工具(因式分解)</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuadraticExplorer />);
    </script>
</body>
</html>
