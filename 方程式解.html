<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方程式數感訓練器</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 載入 Babel 用於瀏覽器端編譯 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 自定義動畫 */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // 為了單一文件運作，我們手寫簡單的 SVG Icon 元件取代 lucide-react
        const Icons = {
            RefreshCw: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            ),
            Trophy: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            ),
            ArrowRight: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            ),
            Activity: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            ),
            RotateCcw: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            )
        };

        const EquationSolver = () => {
            const { useState, useEffect } = React;
            
            // 遊戲狀態
            const [level, setLevel] = useState(1);
            const [score, setScore] = useState(0);
            const [streak, setStreak] = useState(0);
            const [problem, setProblem] = useState(null);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [showExplanation, setShowExplanation] = useState(false);
            const [feedbackText, setFeedbackText] = useState("");

            // 生成題目的邏輯
            const generateProblem = () => {
                let a = 1, b = 0, x = 0;
                
                // 隨機生成解 x (範圍 -9 到 9，避免 0)
                x = Math.floor(Math.random() * 19) - 9;
                if (x === 0) x = 1;

                if (level === 1) {
                    a = 1;
                    b = Math.floor(Math.random() * 20) - 10;
                } else if (level === 2) {
                    a = Math.floor(Math.random() * 9) + 2;
                    if (Math.random() > 0.5) a *= -1;
                    b = 0;
                } else if (level === 3) {
                    a = Math.floor(Math.random() * 5) + 2;
                    b = Math.floor(Math.random() * 20) - 10;
                } else {
                    a = Math.floor(Math.random() * 10) - 5;
                    if (a === 0) a = 2;
                    b = Math.floor(Math.random() * 40) - 20;
                }

                const c = a * x + b;

                // 生成選項
                let choices = new Set();
                choices.add(x);
                
                while (choices.size < 4) {
                    let offset = Math.floor(Math.random() * 5) + 1;
                    if (Math.random() > 0.5) offset *= -1;
                    if (Math.random() > 0.8 && !choices.has(-x)) {
                        choices.add(-x);
                    } else {
                        choices.add(x + offset);
                    }
                }

                const shuffledChoices = Array.from(choices).sort(() => Math.random() - 0.5);

                setProblem({ a, b, c, x, choices: shuffledChoices });
                resetSelection();
            };

            const resetSelection = () => {
                setSelectedAnswer(null);
                setIsCorrect(null);
                setShowExplanation(false);
                setFeedbackText("");
            };

            useEffect(() => {
                generateProblem();
            }, [level]);

            const handleSelect = (choice) => {
                if (selectedAnswer !== null) return;

                setSelectedAnswer(choice);
                
                const lhsValue = problem.a * choice + problem.b;
                
                if (choice === problem.x) {
                    setIsCorrect(true);
                    setScore(score + 10 + streak * 2);
                    setStreak(streak + 1);
                    setFeedbackText("太棒了！左右平衡！");
                } else {
                    setIsCorrect(false);
                    setStreak(0);
                    if (lhsValue > problem.c) {
                        setFeedbackText("左邊算出來太大了，試試小一點的數字？");
                    } else {
                        setFeedbackText("左邊算出來太小了，試試大一點的數字？");
                    }
                }
                
                setShowExplanation(true);
            };

            const nextProblem = () => {
                if (score > 50 && level === 1) setLevel(2);
                if (score > 150 && level === 2) setLevel(3);
                if (score > 300 && level === 3) setLevel(4);
                generateProblem();
            };

            const retryProblem = () => {
                resetSelection();
            };

            const formatEquation = (a, b, c) => {
                let lhs = "";
                if (a === 1) lhs += "x";
                else if (a === -1) lhs += "-x";
                else lhs += `${a}x`;

                if (b > 0) lhs += ` + ${b}`;
                else if (b < 0) lhs += ` - ${Math.abs(b)}`;
                else if (b === 0 && lhs === "") lhs = "0";

                return (
                    <div className="flex items-center justify-center text-4xl md:text-6xl font-bold font-mono tracking-wider text-slate-800 my-8">
                        <span>{lhs}</span>
                        <span className="mx-4 text-slate-400">=</span>
                        <span>{c}</span>
                    </div>
                );
            };

            const renderSubstitution = () => {
                if (!selectedAnswer && selectedAnswer !== 0) return null;

                const { a, b, c } = problem;
                const calcStep1 = a * selectedAnswer;
                const calcTotal = calcStep1 + b;
                const isMatch = calcTotal === c;

                return (
                    <div className="mt-6 bg-white p-6 rounded-xl border-2 border-slate-100 shadow-sm animate-fade-in-up">
                        <h3 className="text-lg font-bold text-slate-500 mb-4 flex items-center">
                            <Icons.Activity />
                            <span className="ml-2">驗算過程 (第一性原理：代入檢查)</span>
                        </h3>
                        
                        <div className="flex flex-col items-center space-y-4 text-xl">
                            <div className="flex items-center space-x-2 flex-wrap justify-center">
                                <span className="text-slate-400">將</span>
                                <span className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold">{selectedAnswer}</span>
                                <span className="text-slate-400">放入方程式的 x :</span>
                            </div>

                            <div className={`flex items-center p-4 rounded-lg bg-slate-50 transition-all duration-500 ${isMatch ? 'border-2 border-green-400 bg-green-50' : 'border-2 border-red-200'}`}>
                                <div className="flex items-center space-x-2 font-mono text-2xl">
                                    <span className="text-slate-500">{a}</span>
                                    <span className="text-slate-300">×</span>
                                    <span className={`font-bold ${isMatch ? 'text-green-600' : 'text-blue-600'}`}>({selectedAnswer})</span>
                                    {b !== 0 && (
                                        <React.Fragment>
                                            <span className="text-slate-300">{b > 0 ? '+' : '-'}</span>
                                            <span className="text-slate-500">{Math.abs(b)}</span>
                                        </React.Fragment>
                                    )}
                                    <span className="text-slate-400 mx-2">?</span>
                                    <span className="text-slate-800">{c}</span>
                                </div>
                            </div>

                            <div className="flex items-center space-x-4 text-3xl font-bold mt-2">
                                <div className={`transform transition-transform duration-500 ${isMatch ? 'scale-110' : ''}`}>
                                    <span className={isMatch ? "text-green-600" : "text-red-500"}>
                                        {calcTotal}
                                    </span>
                                </div>
                                <div className="text-slate-400">
                                    {calcTotal === c ? '=' : '≠'}
                                </div>
                                <div className="text-slate-800">
                                    {c}
                                </div>
                            </div>

                            <div className={`text-lg font-bold mt-2 ${isMatch ? "text-green-600" : "text-red-500"}`}>
                                {feedbackText}
                            </div>
                        </div>
                    </div>
                );
            };

            if (!problem) return <div className="p-10 text-center">正在載入題目...</div>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8 flex flex-col items-center">
                    <header className="w-full max-w-2xl flex justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div className="flex items-center space-x-2">
                            <div className="bg-indigo-600 text-white p-2 rounded-lg">
                                <Icons.RefreshCw />
                            </div>
                            <div>
                                <h1 className="font-bold text-lg text-slate-800">方程式直覺訓練</h1>
                                <p className="text-xs text-slate-500">Level {level} • 尋找平衡點</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center space-x-6">
                            <div className="flex flex-col items-end">
                                <span className="text-xs text-slate-400 uppercase tracking-wider">Score</span>
                                <span className="text-xl font-bold text-indigo-600 font-mono">{score}</span>
                            </div>
                            <div className="flex flex-col items-end hidden md:flex">
                                <span className="text-xs text-slate-400 uppercase tracking-wider">Streak</span>
                                <div className="flex items-center text-orange-500 font-bold">
                                    <Icons.Trophy />
                                    <span className="ml-1">{streak}</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="w-full max-w-2xl">
                        <div className="bg-white rounded-3xl shadow-lg border border-slate-100 p-8 mb-6 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                            
                            <div className="text-center mb-4">
                                <span className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-sm font-medium">
                                    題目：哪一個 x 能讓等式成立？
                                </span>
                            </div>

                            {formatEquation(problem.a, problem.b, problem.c)}

                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
                                {problem.choices.map((choice, idx) => {
                                    let btnClass = "bg-slate-50 hover:bg-indigo-50 border-2 border-slate-200 text-slate-700";
                                    
                                    if (selectedAnswer !== null) {
                                        if (choice === problem.x) {
                                            btnClass = "bg-green-100 border-green-500 text-green-700 shadow-md transform scale-105";
                                        } else if (choice === selectedAnswer && choice !== problem.x) {
                                            btnClass = "bg-red-100 border-red-400 text-red-700 opacity-70";
                                        } else {
                                            btnClass = "bg-slate-50 border-slate-100 text-slate-300 opacity-50";
                                        }
                                    }

                                    return (
                                        <button
                                            key={idx}
                                            onClick={() => handleSelect(choice)}
                                            disabled={selectedAnswer !== null}
                                            className={`
                                                p-6 rounded-2xl text-2xl font-bold font-mono transition-all duration-300
                                                flex flex-col items-center justify-center
                                                ${btnClass}
                                            `}
                                        >
                                            <span className="text-xs text-slate-400 font-sans mb-1">x =</span>
                                            {choice}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className={`transition-all duration-500 ease-in-out ${showExplanation ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                            {showExplanation && (
                                <React.Fragment>
                                    {renderSubstitution()}
                                    
                                    <div className="mt-6 flex justify-center">
                                        <button
                                            onClick={isCorrect ? nextProblem : retryProblem}
                                            className={`
                                                flex items-center px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1
                                                ${isCorrect ? 'bg-indigo-600 hover:bg-indigo-700 text-white' : 'bg-amber-500 hover:bg-amber-600 text-white'}
                                            `}
                                        >
                                            {isCorrect ? (
                                                <React.Fragment>
                                                    下一題 <span className="ml-2"><Icons.ArrowRight /></span>
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    重選一次 <span className="ml-2"><Icons.RotateCcw /></span>
                                                </React.Fragment>
                                            )}
                                        </button>
                                    </div>
                                </React.Fragment>
                            )}
                        </div>
                    </main>

                    <footer className="mt-12 text-slate-400 text-sm max-w-lg text-center leading-relaxed">
                        <p>
                            <span className="font-bold text-slate-500">第一性原理提示：</span> 
                            解方程式不只是在移動數字。真正的解，是那個唯一能讓
                            <br/>「左邊算出來的數值」等於「右邊數值」的數字。
                        </p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EquationSolver />);
    </script>
</body>
</html>```

