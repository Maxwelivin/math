<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‰©ç†æ•™å­¸ï¼šæ³¢çš„é€±æœŸå®šç¾© v5.0 (å®Œæ•´ä»‹è³ªç‰ˆ)</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 900px;
            max-width: 95vw;
            text-align: center;
        }
        canvas {
            background-color: #fff;
            border: 2px solid #333;
            border-radius: 8px;
            width: 100%;
            height: 360px; /* ç¨å¾®åŠ é«˜ä¸€é» */
            image-rendering: -webkit-optimize-contrast;
        }
        
        /* è³‡è¨Šé¢æ¿ */
        .info-panel {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        .info-box {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.95rem;
            background: #fff;
            color: #000;
            font-weight: bold;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .box-1 { border-color: #E91E63; color: #C2185B; } /* æ”¹ç‚ºç²‰ç´…è‰²å°æ‡‰æ¨™è¨˜ */
        .box-2 { border-color: #4CAF50; color: #2E7D32; }
        .box-3 { border-color: #2196F3; color: #1565C0; }

        /* æ§åˆ¶å€ */
        .controls {
            margin-top: 20px;
            padding: 15px;
            background: #eceff1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        button:active { transform: scale(0.98); }

        .btn-primary { background-color: #2196F3; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1976D2; }
        
        .btn-next-step { background-color: #9C27B0; color: white; display: none; }
        .btn-next-step:hover { background-color: #7B1FA2; }

        .btn-continuous { background-color: #FF9800; color: white; display: none; }
        .btn-continuous:hover { background-color: #F57C00; }

        .btn-reset { background-color: #607d8b; color: white; }
        .btn-reset:hover { background-color: #455a64; }

        .slider-container {
            background: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type=range] { accent-color: #2196F3; cursor: pointer; }
        
        #statusText {
            font-size: 0.9rem; color: #555; margin-left: 10px; font-weight: bold; min-width: 120px; text-align: left;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="color:#37474f; margin: 10px 0;">â±ï¸ æ³¢çš„é€±æœŸèˆ‡ä»‹è³ªé‹å‹• (v5.0)</h2>
        
        <canvas id="simCanvas" width="900" height="360"></canvas>

        <div class="info-panel">
            <div class="info-box box-1" id="info1">
                ğŸ”´ è§€é» 1 (ä»‹è³ª)<br>ç¹©ä¸Šä»»æ„é»<br>åŸåœ°ä¸Šä¸‹éœ‡å‹•
            </div>
            <div class="info-box box-2" id="info2">
                ğŸŸ¢ è§€é» 2 (æ³¢æº)<br>æ³¢æºç”¢ç”Ÿ<br>å®Œæ•´å…¨æ³¢
            </div>
            <div class="info-box box-3" id="info3">
                ğŸ”µ è§€é» 3 (å‚³é)<br>æ³¢å½¢å‰é€²è·é›¢<br>($N \times \lambda$)
            </div>
        </div>

        <div class="controls">
            <div class="slider-container">
                <label>é€±æœŸ T: <span id="valT" style="color:#2196F3; font-weight:bold;">2.0</span>s</label>
                <input type="range" id="rangeT" min="1.0" max="4.0" step="0.5" value="2.0">
            </div>

            <button id="btnStart" class="btn-primary">â–¶ é–‹å§‹æ¼”ç¤º (ç¬¬ä¸€å€‹é€±æœŸ)</button>
            <button id="btnStep" class="btn-next-step">â¯ å†è·‘ä¸€å€‹é€±æœŸ (+1T)</button>
            <button id="btnCont" class="btn-continuous">â© ç„¡é™å‚³é (ä¸æš«åœ)</button>
            <button id="btnReset" class="btn-reset">â†º é‡ç½®</button>
            
            <span id="statusText"></span>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            const canvas = document.getElementById('simCanvas');
            const ctx = canvas.getContext('2d');
            
            // UI å…ƒä»¶
            const btnStart = document.getElementById('btnStart');
            const btnStep = document.getElementById('btnStep');
            const btnCont = document.getElementById('btnCont');
            const btnReset = document.getElementById('btnReset');
            const rangeT = document.getElementById('rangeT');
            const valT = document.getElementById('valT');
            const statusText = document.getElementById('statusText');

            // ç‰©ç†åƒæ•¸
            let T = 2.0;
            let lambda = 200;
            let amp = 60; // ç¨å¾®åŠ å¤§æŒ¯å¹…è®“è§€å¯Ÿæ›´æ¸…æ¥š
            const markerSpacing = 40; // ä»‹è³ªæ¨™è¨˜é»çš„é–“è·
            
            // ç³»çµ±ç‹€æ…‹
            let time = 0;
            let isRunning = false;
            let animationId;
            let lastTime = 0;
            let mode = 'initial'; 
            let targetTime = T;

            drawScene();

            // --- äº‹ä»¶ç›£è½ ---
            rangeT.addEventListener('input', function() {
                T = parseFloat(this.value);
                valT.textContent = T.toFixed(1);
                resetSim();
            });
            btnStart.addEventListener('click', function() { startSim('step'); });
            btnStep.addEventListener('click', function() { targetTime += T; startSim('step'); });
            btnCont.addEventListener('click', function() { targetTime = Infinity; startSim('continuous'); });
            btnReset.addEventListener('click', resetSim);

            // --- æ ¸å¿ƒé‚è¼¯ ---
            function startSim(newMode) {
                if (isRunning && newMode === mode) return;
                mode = newMode;
                isRunning = true;
                lastTime = performance.now();
                updateButtonsState(true);
                if (!animationId) loop(lastTime);
            }

            function resetSim() {
                isRunning = false;
                cancelAnimationFrame(animationId);
                animationId = null;
                time = 0;
                targetTime = T;
                mode = 'initial';
                updateButtonsState(false);
                statusText.textContent = "";
                statusText.style.color = "#555";
                drawScene();
            }

            function pauseSim(reason) {
                isRunning = false;
                cancelAnimationFrame(animationId);
                animationId = null;
                updateButtonsState(false);
                statusText.textContent = reason;
                statusText.style.color = "#4CAF50";
                drawScene();
            }

            function updateButtonsState(running) {
                if (running) {
                    btnStart.disabled = true; btnStep.disabled = true; btnCont.disabled = true;
                    statusText.textContent = mode === 'step' ? "â³ å‚³éä¸­ (å°‡è‡ªå‹•æš«åœ)..." : "â© é€£çºŒå‚³éä¸­...";
                } else {
                    btnStart.style.display = 'none';
                    btnStep.style.display = 'inline-flex'; btnStep.disabled = false;
                    btnStep.innerHTML = `â¯ å†è·‘ä¸€å€‹é€±æœŸ (åœåœ¨ ${(targetTime/T + 1).toFixed(0)}T)`;
                    btnCont.style.display = 'inline-flex'; btnCont.disabled = false;
                }
                if (time === 0) {
                    btnStart.style.display = 'inline-flex'; btnStart.disabled = false;
                    btnStep.style.display = 'none'; btnCont.style.display = 'none';
                }
            }

            function loop(now) {
                if (!isRunning) return;
                const dt = (now - lastTime) / 1000;
                lastTime = now;
                time += dt;
                if (mode === 'step' && time >= targetTime) {
                    time = targetTime;
                    pauseSim(`âœ… å·²æš«åœæ–¼ ${ (time/T).toFixed(0) } å€‹é€±æœŸ`);
                    return;
                }
                drawScene();
                animationId = requestAnimationFrame(loop);
            }

            function drawScene() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const centerY = canvas.height / 2;
                const startX = 50;
                const width = canvas.width;
                
                // 1. ç¹ªè£½èƒŒæ™¯æ ¼ç·šèˆ‡å¹³è¡¡ä½ç½®
                drawGrid(ctx, width, canvas.height, startX, centerY, lambda);

                // ç‰©ç†è¨ˆç®—
                const omega = (2 * Math.PI) / T;
                const k = (2 * Math.PI) / lambda;
                const v = lambda / T;
                const frontX = v * time; // æ³¢å‰ä½ç½®

                // 2. ç¹ªè£½æ•´æ¢ç¹©å­ (ä¿®æ”¹é» 1ï¼šåŸæœ¬å°±æœ‰ç¹©å­)
                ctx.beginPath();
                ctx.strokeStyle = "#333";
                ctx.lineWidth = 3;
                ctx.lineJoin = 'round';
                
                // æˆ‘å€‘ç¹ªè£½æ•´æ¢ç¹©å­ç›´åˆ°ç•«å¸ƒé‚Šç·£
                for (let x = 0; x < width - startX; x += 2) {
                    let y = 0; // é è¨­åœ¨å¹³è¡¡ä½ç½®
                    // åªæœ‰æ³¢å‰åˆ°é”çš„åœ°æ–¹æ‰è¨ˆç®—ä½ç§»
                    if (x <= frontX) {
                        y = amp * Math.sin(omega * time - k * x);
                    }
                    if (x === 0) ctx.moveTo(startX + x, centerY - y);
                    else ctx.lineTo(startX + x, centerY - y);
                }
                ctx.stroke();

                // --- è¦–è¦ºè¼”åŠ©å±¤ ---

                // (A) ä»‹è³ªè³ªé»æ¨™è¨˜ (ä¿®æ”¹é» 2ï¼šå¤šé»æ¨™è¨˜èˆ‡å‚ç›´è»Œè·¡)
                ctx.fillStyle = "#E91E63"; // ç²‰ç´…è‰²
                
                // éæ­·æ•´æ¢ç¹©å­ï¼Œæ¯éš” markerSpacing ç•«ä¸€å€‹é»
                for (let mx = 0; mx < width - startX; mx += markerSpacing) {
                    let my = 0;
                    // è¨ˆç®—è©²é»ç›®å‰çš„ä½ç§»
                    if (mx <= frontX) {
                        my = amp * Math.sin(omega * time - k * mx);
                    }

                    // ç•«å‚ç›´é™åˆ¶è»Œè·¡ (æ·¡æ·¡çš„ç²‰ç´…è™›ç·š)
                    ctx.beginPath();
                    ctx.setLineDash([2, 3]);
                    ctx.strokeStyle = "rgba(233, 30, 99, 0.3)";
                    ctx.moveTo(startX + mx, centerY - amp);
                    ctx.lineTo(startX + mx, centerY + amp);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // ç•«è³ªé»
                    ctx.beginPath();
                    ctx.arc(startX + mx, centerY - my, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // åªåœ¨æºé ­çš„é»é¡¯ç¤ºéœ‡å‹•æ¬¡æ•¸æ–‡å­—ï¼Œé¿å…ç•«é¢å¤ªäº‚
                    if (mx === 0) {
                        let cycles = (time / T).toFixed(1);
                        ctx.fillStyle = "#333";
                        ctx.font = "12px Arial";
                        ctx.fillText(`éœ‡å‹•: ${cycles} æ¬¡`, startX - 35, centerY - amp - 15);
                        ctx.fillStyle = "#E91E63"; // æ”¹å›ç²‰ç´…è‰²ç•«ä¸‹ä¸€å€‹é»
                    }
                }

                // (B) ç¶ è‰²å…¨æ³¢æ¨™ç¤º (åƒ…æ¨™ç¤ºå·²ç”¢ç”Ÿçš„æ³¢éƒ¨åˆ†)
                if (time > 0) {
                    ctx.beginPath();
                    ctx.strokeStyle = "rgba(76, 175, 80, 0.4)";
                    ctx.lineWidth = 8;
                    let drawEnd = Math.min(frontX, width - startX);
                    for (let x = 0; x <= drawEnd; x+=4) {
                        let y = amp * Math.sin(omega * time - k * x);
                        if (x===0) ctx.moveTo(startX + x, centerY - y);
                        else ctx.lineTo(startX + x, centerY - y);
                    }
                    ctx.stroke();
                }

                // (C) è—è‰²å‚³éè·é›¢æ¨™ç¤º
                if (frontX > 10) {
                    let currentFront = startX + frontX;
                    let arrowEnd = Math.min(currentFront, width - 10);
                    drawArrow(ctx, startX, centerY - amp - 40, arrowEnd, centerY - amp - 40, "#2196F3");
                    if (currentFront < width) {
                        ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.strokeStyle = "#2196F3";
                        ctx.moveTo(currentFront, centerY - amp - 40); ctx.lineTo(currentFront, centerY + amp); ctx.stroke(); ctx.setLineDash([]);
                    }
                    let distLambda = (frontX / lambda).toFixed(1);
                    ctx.fillStyle = "#1976D2"; ctx.font = "bold 14px Arial";
                    let textPos = (startX + arrowEnd) / 2;
                    ctx.fillText(`è·é›¢: ${distLambda}Î»`, textPos - 30, centerY - amp - 50);
                }
            }

            function drawGrid(ctx, w, h, startX, centerY, lambda) {
                // ç¹ªè£½å¹³è¡¡ä½ç½®åŸºæº–ç·š (å¼·åŒ–é¡¯ç¤º)
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(w, centerY);
                ctx.strokeStyle = "#bbb";
                ctx.lineWidth = 2;
                ctx.stroke();

                // å‚ç›´åˆ»åº¦
                ctx.lineWidth = 1;
                let maxLambda = Math.ceil((w - startX) / lambda);
                for(let i=0; i<=maxLambda; i++) {
                    let x = startX + i * lambda;
                    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h);
                    ctx.strokeStyle = (i===0) ? "#999" : "#e0e0e0"; ctx.stroke();
                    ctx.fillStyle = "#999"; ctx.font = "12px Arial"; ctx.fillText(i + "Î»", x + 5, h - 10);
                }
            }

            function drawArrow(ctx, fromX, fromY, toX, toY, color) {
                const headlen = 10; const angle = Math.atan2(toY - fromY, toX - fromX);
                ctx.beginPath(); ctx.moveTo(fromX, fromY); ctx.lineTo(toX, toY);
                ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
                ctx.fillStyle = color; ctx.fill();
            }
        });
    </script>
</body>
</html>
